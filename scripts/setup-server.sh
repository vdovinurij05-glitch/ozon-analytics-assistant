#!/bin/bash

# ===========================================
# Ozon Analytics Assistant - Server Setup
# –î–ª—è Ubuntu 22.04 / Debian 12
# ===========================================

set -e

echo "üöÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è Ozon Analytics Assistant"
echo "================================================="

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å sudo: sudo bash setup-server.sh"
  exit 1
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo "üì¶ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã..."
apt update && apt upgrade -y

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker
echo "üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker..."
if ! command -v docker &> /dev/null; then
    curl -fsSL https://get.docker.com -o get-docker.sh
    sh get-docker.sh
    rm get-docker.sh

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø—É docker
    usermod -aG docker $SUDO_USER
else
    echo "Docker —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
echo "üê≥ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose..."
if ! command -v docker-compose &> /dev/null; then
    apt install -y docker-compose-plugin
else
    echo "Docker Compose —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞..."
mkdir -p /opt/ozon-assistant
chown -R $SUDO_USER:$SUDO_USER /opt/ozon-assistant

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤..."
apt install -y curl wget git htop

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞
echo "üî• –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ñ–∞–π—Ä–≤–æ–ª–∞..."
apt install -y ufw
ufw allow ssh
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 3000/tcp  # API –ø–æ—Ä—Ç (–º–æ–∂–Ω–æ —É–±—Ä–∞—Ç—å –ø–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ nginx)
ufw --force enable

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ swap (–µ—Å–ª–∏ –º–∞–ª–æ RAM)
echo "üíæ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ swap..."
if [ ! -f /swapfile ]; then
    fallocate -l 2G /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    echo '/swapfile none swap sw 0 0' >> /etc/fstab
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–µ–ø–ª–æ—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
echo "üë§ –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy..."
if ! id "deploy" &>/dev/null; then
    useradd -m -s /bin/bash deploy
    usermod -aG docker deploy
    mkdir -p /home/deploy/.ssh
    chmod 700 /home/deploy/.ssh

    echo ""
    echo "‚ö†Ô∏è  –î–æ–±–∞–≤—å—Ç–µ SSH –∫–ª—é—á –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy:"
    echo "   echo '–≤–∞—à_–ø—É–±–ª–∏—á–Ω—ã–π_–∫–ª—é—á' >> /home/deploy/.ssh/authorized_keys"
    echo ""
fi

# –ò—Ç–æ–≥–∏
echo ""
echo "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –î–æ–±–∞–≤—å—Ç–µ SSH –∫–ª—é—á:"
echo "   ssh-keygen -t ed25519 -C 'github-actions'"
echo "   cat ~/.ssh/id_ed25519.pub >> /home/deploy/.ssh/authorized_keys"
echo ""
echo "2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –¥–ª—è GitHub Secrets:"
echo "   cat ~/.ssh/id_ed25519"
echo ""
echo "3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ GitHub Secrets:"
echo "   - SERVER_IP: $(curl -s ifconfig.me)"
echo "   - SERVER_USER: deploy"
echo "   - SSH_PRIVATE_KEY: (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ id_ed25519)"
echo "   - ANTHROPIC_API_KEY: (–≤–∞—à –∫–ª—é—á)"
echo "   - JWT_SECRET: $(openssl rand -base64 32)"
echo "   - POSTGRES_PASSWORD: $(openssl rand -base64 16)"
echo ""
echo "4. –°–¥–µ–ª–∞–π—Ç–µ push –≤ main –≤–µ—Ç–∫—É –¥–ª—è –¥–µ–ø–ª–æ—è"
echo ""
