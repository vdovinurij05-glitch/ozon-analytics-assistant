# Техническое задание: Ozon Analytics Assistant

## Общее описание

Прокси-сервис между селлерами Ozon и Claude API. Плагин для Chrome собирает данные со страниц аналитики Ozon, отправляет на наш сервер, сервер обрабатывает и перенаправляет в Claude API.

---

## Архитектура

```
┌──────────────────┐      ┌─────────────────────────┐      ┌───────────┐
│  Chrome плагин   │      │     НАШ СЕРВЕР          │      │           │
│  (у селлера)     │─────▶│                         │─────▶│  Claude   │
│                  │      │  - Авторизация          │      │   API     │
│  - Сбор данных   │◀─────│  - Хранение истории     │◀─────│           │
│  - UI чата       │      │  - Биллинг              │      │  (наш     │
│                  │      │  - Prompt caching       │      │  API key) │
└──────────────────┘      └─────────────────────────┘      └───────────┘
```

---

## 1. Система авторизации

### 1.1 API ключи клиентов
- [ ] Каждый селлер получает уникальный API ключ к нашему сервису
- [ ] Формат ключа: `oaa_` + случайная строка (например: `oaa_sk_7f3a8b2c...`)
- [ ] Ключи хранятся в БД в хэшированном виде
- [ ] Возможность отзыва/перегенерации ключа

### 1.2 API ключ Claude
- [ ] Один API ключ Anthropic на сервере
- [ ] Хранится в переменных окружения (не в коде)

---

## 2. Система баланса и биллинга

### 2.1 Баланс клиента
- [ ] У каждого клиента есть баланс в рублях/долларах
- [ ] Баланс отображается в плагине в реальном времени
- [ ] После каждого запроса показывается расход токенов

### 2.2 Расчёт стоимости

**Формула для клиента:**
```
Стоимость_для_клиента = Реальная_стоимость_Claude × 3
```

**Базовые цены Claude Sonnet (наша себестоимость):**
| Тип | Цена за 1M токенов |
|-----|-------------------|
| Input токены | $3 |
| Output токены | $15 |

**Цены для клиента (×3):**
| Тип | Цена за 1M токенов |
|-----|-------------------|
| Input токены | $9 |
| Output токены | $45 |

### 2.3 Отображение расхода
- [ ] После каждого запроса показывать:
  - Input токены (сколько потрачено)
  - Output токены (сколько потрачено)
  - Стоимость запроса
  - Остаток баланса

---

## 3. Хранение данных

### 3.1 База данных

**Таблица: users**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | Уникальный ID |
| email | STRING | Email пользователя |
| api_key_hash | STRING | Хэш API ключа |
| balance | DECIMAL | Текущий баланс |
| created_at | TIMESTAMP | Дата регистрации |

**Таблица: sessions**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | ID сессии |
| user_id | UUID | FK → users |
| page_url | STRING | URL страницы Ozon |
| created_at | TIMESTAMP | Начало сессии |

**Таблица: messages**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | ID сообщения |
| session_id | UUID | FK → sessions |
| role | ENUM | user / assistant |
| content | TEXT | Текст сообщения |
| page_data | JSON | Данные со страницы (если есть) |
| input_tokens | INT | Потрачено input токенов |
| output_tokens | INT | Потрачено output токенов |
| cost | DECIMAL | Стоимость запроса |
| created_at | TIMESTAMP | Время сообщения |

**Таблица: transactions**
| Поле | Тип | Описание |
|------|-----|----------|
| id | UUID | ID транзакции |
| user_id | UUID | FK → users |
| type | ENUM | topup / usage |
| amount | DECIMAL | Сумма |
| description | STRING | Описание |
| created_at | TIMESTAMP | Время |

---

## 4. API эндпоинты сервера

### 4.1 Авторизация
```
POST /api/auth/register    - Регистрация
POST /api/auth/login       - Вход
POST /api/auth/api-key     - Получить/сгенерировать API ключ
```

### 4.2 Чат
```
POST /api/chat/message     - Отправить сообщение
GET  /api/chat/sessions    - Список сессий пользователя
GET  /api/chat/history/:sessionId - История сессии
```

### 4.3 Баланс
```
GET  /api/billing/balance  - Текущий баланс
GET  /api/billing/usage    - История расходов
POST /api/billing/topup    - Пополнение (интеграция с платёжкой)
```

---

## 5. Chrome плагин

### 5.1 Поддерживаемые сайты

| Сайт | Назначение |
|------|------------|
| seller.ozon.ru | Кабинет продавца — аналитика, продажи, товары |
| ozon.ru | Основной сайт — анализ конкурентов |

### 5.2 Режимы работы

#### Режим 1: Кабинет селлера (seller.ozon.ru)
Анализ собственных данных продавца:
- [ ] Статистика продаж и выручка
- [ ] Аналитика товаров (просмотры, конверсия, возвраты)
- [ ] Остатки на складах
- [ ] Рекламные кампании (расходы, CTR, ROI)
- [ ] Отзывы и рейтинги
- [ ] Финансовые отчёты
- [ ] Заказы и возвраты

#### Режим 2: Анализ конкурентов (ozon.ru)
Сбор данных о конкурентах:
- [ ] Карточки товаров конкурентов (цена, рейтинг, отзывы, продажи)
- [ ] Поисковая выдача (позиции, количество конкурентов)
- [ ] Категории товаров (топ продавцы, средние цены)
- [ ] Акции и скидки конкурентов
- [ ] Контент карточек (фото, описания, характеристики)

### 5.3 Аналитические возможности

#### Сравнительный анализ
- [ ] Сравнение своих товаров с конкурентами
- [ ] Анализ ценообразования (свои цены vs рынок)
- [ ] Сравнение рейтингов и отзывов
- [ ] Анализ контента карточек

#### Рекомендации AI
- [ ] Оптимизация цен
- [ ] Улучшение карточек товаров
- [ ] Рекомендации по рекламе
- [ ] Выявление трендов и ниш
- [ ] Прогнозирование спроса

### 5.4 Сбор данных по страницам

**seller.ozon.ru:**
| Страница | Собираемые данные |
|----------|-------------------|
| /analytics | Графики, метрики, KPI |
| /products | Список товаров, остатки, цены |
| /orders | Заказы, статусы, суммы |
| /finance | Выручка, комиссии, выплаты |
| /promotion | Рекламные кампании, статистика |
| /reviews | Отзывы, рейтинги |

**ozon.ru:**
| Страница | Собираемые данные |
|----------|-------------------|
| /product/* | Карточка товара конкурента |
| /category/* | Список товаров в категории |
| /search/* | Поисковая выдача |
| /seller/* | Страница продавца-конкурента |

### 5.5 UI функционал
- [ ] Плавающая кнопка на обоих сайтах
- [ ] Чат-интерфейс для общения с AI
- [ ] Отображение баланса и расхода токенов
- [ ] Индикатор текущего режима (Кабинет / Конкуренты)
- [ ] Быстрые действия: "Сравнить с конкурентами", "Дать рекомендации"
- [ ] Настройки (API ключ, лимиты)

### 5.6 Отображаемая информация
- [ ] Текущий баланс (в шапке чата)
- [ ] После каждого ответа: "Использовано: X токенов ($Y)"
- [ ] Текущий режим работы (иконка/бейдж)

---

## 6. Сессии и сохранение контекста

### 6.1 Логика сессий

```
┌─────────────────────────────────────────────────────────────┐
│                      ПОЛЬЗОВАТЕЛЬ                           │
├─────────────────────────────────────────────────────────────┤
│  Сессия 1 (seller.ozon.ru)          Сессия 2 (ozon.ru)     │
│  ├── Сообщение 1                    ├── Сообщение 1        │
│  ├── Сообщение 2                    ├── Сообщение 2        │
│  └── ...                            └── ...                │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 Правила сессий

| Ситуация | Поведение |
|----------|-----------|
| Переход между страницами seller.ozon.ru | Сессия сохраняется, история видна |
| Переход между страницами ozon.ru | Сессия сохраняется, история видна |
| Переход seller.ozon.ru → ozon.ru | Новая сессия (разные режимы) |
| Закрытие браузера | Сессия сохраняется на сервере |
| Открытие браузера заново | Последняя сессия восстанавливается |
| Прошло 24 часа без активности | Новая сессия |

### 6.3 Сохранение на клиенте (плагин)

- [ ] Кэширование последних сообщений в localStorage
- [ ] При открытии страницы — загрузка истории с сервера
- [ ] Мгновенное отображение кэша, затем синхронизация
- [ ] Индикатор "Загрузка истории..."

### 6.4 Сохранение на сервере

- [ ] Полная история всех сессий в БД
- [ ] API для получения истории: `GET /api/chat/history?session_id=X`
- [ ] Автоматическое создание сессии при первом сообщении
- [ ] Привязка сессии к домену (seller.ozon.ru / ozon.ru)

### 6.5 Контекст между страницами

При переходе на новую страницу:
1. История чата сохраняется и отображается
2. Данные новой страницы собираются автоматически
3. AI понимает, что страница изменилась
4. Можно ссылаться на данные с предыдущих страниц

**Пример диалога:**
```
[Страница: Аналитика продаж]
User: Какой товар лидер продаж?
AI: Товар "X" с выручкой 500,000₽

[Переход на: Страница товара X]
User: Как улучшить эту карточку?
AI: Вижу карточку товара "X". Рекомендую... (контекст сохранён)
```

### 6.6 UI истории в плагине

- [ ] Список сообщений с прокруткой
- [ ] Разделители по датам
- [ ] Индикатор "Страница изменилась" между сообщениями
- [ ] Кнопка "Очистить историю" (новая сессия)
- [ ] Подгрузка старых сообщений при скролле вверх

---

## 7. Оптимизации

### 7.1 Prompt Caching
- [ ] Кэширование системного промпта
- [ ] Кэширование данных страницы (если не изменились)

### 7.2 Лимиты
- [ ] Максимум 20 сообщений в истории сессии
- [ ] Суммаризация старых сообщений при превышении
- [ ] Новая страница = новая сессия

---

## 8. Технологии (предварительно)

| Компонент | Технология |
|-----------|------------|
| Бэкенд | Node.js + Express / Python + FastAPI |
| База данных | PostgreSQL |
| Кэш | Redis (для сессий) |
| Плагин | JavaScript (Manifest V3) |
| Хостинг | VPS / Railway / Vercel |

---

## 9. Безопасность

### 9.1 Защита API
- [ ] Rate limiting (лимит запросов в минуту на пользователя)
- [ ] Валидация всех входящих данных
- [ ] HTTPS только
- [ ] CORS — только разрешённые домены (ozon.ru, seller.ozon.ru)

### 9.2 Защита от злоупотреблений
- [ ] Блокировка при подозрительной активности
- [ ] Лимит на размер данных страницы (макс. 100KB)
- [ ] Защита от спама (минимум 2 сек между запросами)
- [ ] Автоблокировка при отрицательном балансе

### 9.3 Хранение данных
- [ ] Хэширование API ключей (bcrypt)
- [ ] Шифрование чувствительных данных в БД
- [ ] Автоудаление старых сессий (90 дней)

---

## 10. Уведомления

### 10.1 В плагине
- [ ] "Баланс заканчивается" (< $5)
- [ ] "Баланс исчерпан" — блокировка запросов
- [ ] Ошибки подключения к серверу

### 10.2 Email / Telegram (опционально)
- [ ] Низкий баланс
- [ ] Еженедельный отчёт по расходам
- [ ] Новые фичи / обновления

---

## 11. Админ-панель (веб)

### 11.1 Для вас (владельца)
- [ ] Список всех пользователей
- [ ] Общая статистика (запросы, токены, выручка)
- [ ] Ручное пополнение баланса пользователю
- [ ] Блокировка/разблокировка пользователей
- [ ] Логи ошибок
- [ ] Расходы на Claude API (ваши затраты)

### 11.2 Метрики дашборда
- [ ] Активные пользователи (DAU/MAU)
- [ ] Доход за день/неделю/месяц
- [ ] Средний чек пополнения
- [ ] Топ пользователей по расходам

---

## 12. Обработка ошибок

| Ситуация | Поведение |
|----------|-----------|
| Claude API недоступен | Показать "Сервис временно недоступен", retry через 30 сек |
| Превышен лимит Claude | Очередь запросов, уведомление пользователю |
| Невалидный API ключ клиента | "Проверьте настройки API ключа" |
| Баланс = 0 | Блокировка с предложением пополнить |
| Ошибка парсинга страницы | Отправить что есть + предупреждение |

---

## 13. Онбординг новых пользователей

### 13.1 Регистрация
- [ ] Email + пароль (или OAuth через Google)
- [ ] Подтверждение email
- [ ] Генерация API ключа

### 13.2 Обязательная подписка на Telegram
- [ ] **Для использования сервиса необходимо подписаться на @first_seller**
- [ ] Ссылка на канал в плагине и на сайте
- [ ] Напоминание о подписке при регистрации
- [ ] Уведомление: "Подпишитесь на @first_seller для доступа к сервису"

### 13.3 Бесплатный старт
- [ ] Бонус при регистрации: $1-2 (≈30-50 запросов)
- [ ] Лимит: 10 запросов в день на бесплатном тарифе

### 13.4 Туториал в плагине
- [ ] Первый запуск: "Добро пожаловать! Вот как пользоваться..."
- [ ] Подсказки при наведении
- [ ] Примеры вопросов

---

## 14. Аналитика использования (для вас)

### 14.1 Трекинг
- [ ] Какие страницы Ozon популярнее
- [ ] Самые частые типы вопросов
- [ ] Среднее количество сообщений в сессии
- [ ] Конверсия: регистрация → первый платёж

### 14.2 Инструменты
- [ ] Простая своя аналитика в БД
- [ ] Или интеграция с Amplitude / Mixpanel

---

## 15. Будущие фичи (v2.0)

- [ ] Telegram-бот (дублирование функционала)
- [ ] Автоматические отчёты по расписанию
- [ ] Сравнение периодов (эта неделя vs прошлая)
- [ ] Экспорт в Excel/PDF
- [ ] Мониторинг конкурентов (уведомления об изменении цен)
- [ ] API для интеграции с другими сервисами
- [ ] Реферальная программа

---

## 16. Открытые вопросы

- [ ] Способ пополнения баланса (ЮKassa, Stripe, криптовалюта?)
- [ ] Минимальный депозит?
- [ ] Бесплатный пробный период / токены?
- [ ] Личный кабинет (веб-интерфейс) — нужен ли сразу?
- [ ] Тарифные планы или только pay-as-you-go?
- [ ] Хостинг: VPS (свой сервер) или облако (Railway/Render)?
- [ ] Домен для сервиса?

---

*Документ обновляется по мере уточнения требований*
